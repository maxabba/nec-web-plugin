<?php
// Script temporaneo per aggiornare l'autore dei manifesti - CON BACKUP
// DA ELIMINARE DOPO L'USO

// Password di protezione
$password = 'temp123';

if (!isset($_GET['pass']) || $_GET['pass'] !== $password) {
    die('Accesso non autorizzato');
}

// Carica WordPress
require_once(dirname(__FILE__) . '/../../../wp-config.php');
global $wpdb;

$action = isset($_GET['action']) ? $_GET['action'] : 'preview';

// Lista delle coppie (id_old_manifesto, id_old_annuncio) - DIVISE IN BATCH
$coppie_batch1 = array(
    "('23851','3237'),('23852','3237'),('24321','3343'),('24324','3343'),('24360','3343'),('24369','3343'),('24580','3384'),('24581','3384'),('51164','7077'),('58432','8290'),('69815','9940'),('70817','10085'),('70818','10085'),('71274','10085'),('71552','10164')",
    "('72010','10197'),('72011','10197'),('72034','10197'),('73293','10361'),('73434','10369'),('73836','10415'),('74723','10520'),('74761','10521'),('74767','10520'),('76225','10686'),('77151','10833'),('77152','10833'),('77358','10867'),('77359','10867'),('77363','10867')",
    "('77471','10875'),('78206','10948'),('78207','10948'),('78243','10952'),('78387','10959'),('78388','10959'),('78410','10959'),('78482','10959'),('79016','11040'),('79017','11040'),('79018','11040'),('79464','11076'),('79784','11095'),('79786','11095'),('79788','11095')",
    "('79789','11095'),('79791','11095'),('79792','11095'),('79795','11095'),('79796','11095'),('79797','11095'),('79798','11095'),('79799','11095'),('79800','11095'),('79816','11118'),('79817','11118'),('79850','11118'),('79927','11127'),('79952','11127'),('79989','11126')",
    "('79992','11126'),('80510','11170'),('80511','11170'),('80513','11170'),('80563','11170'),('80564','11175'),('80566','11175'),('80570','11175'),('80581','11175'),('80784','11193'),('80786','11193'),('80791','11193'),('80798','11193'),('80799','11193'),('80801','11193')",
    "('80802','11193'),('81639','11249'),('81751','11256'),('81752','11256'),('81753','11256'),('81760','11256'),('81810','11256'),('81811','11256'),('81813','11256'),('81924','11256'),('81966','11256'),('82104','11290'),('82105','11290'),('82106','11290'),('82107','11290')",
    "('82173','11290'),('82174','11290'),('82175','11290'),('82591','11290'),('82686','11317'),('82845','11329'),('82850','11329'),('82922','11345'),('82951','11345'),('82965','11345'),('82970','11345'),('82971','11345'),('82972','11345'),('82973','11345'),('82974','11345')",
    "('82981','11345'),('83181','11345'),('83331','11366'),('83557','11376'),('83592','11377'),('83596','11377'),('83597','11377'),('83607','11377'),('83610','11377'),('83611','11377'),('83612','11377'),('83615','11377'),('83641','11377'),('83642','11377'),('85184','11464')",
    "('85428','11492'),('85429','11492'),('85493','11509'),('86292','11548'),('86293','11548'),('87104','11609'),('87216','11624'),('87228','11624'),('87229','11624'),('87230','11624'),('87231','11624'),('87266','11624'),('87267','11624'),('87271','11635'),('87285','11637')",
    "('87293','11637'),('87294','11637'),('87295','11638'),('87309','11637'),('87310','11637'),('87335','11637'),('87338','11637'),('87362','11647'),('87363','11647'),('87974','11732'),('87975','11732'),('87984','11735'),('88191','11752'),('88224','11758'),('88647','11797')",
    "('88905','11822'),('88967','11838'),('89146','11869'),('89147','11869'),('89722','11937'),('89724','11937'),('89727','11937'),('89855','11937'),('89947','11937'),('90008','11951'),('90027','11951'),('90238','11980'),('90272','11985'),('90273','11985'),('90511','12003')",
    "('91547','12105'),('91669','12126'),('91696','12126'),('91716','12126'),('92040','12171'),('92183','12188'),('92184','12188'),('92186','12188'),('92187','12188'),('92188','12188'),('92195','12188'),('92196','12188'),('92197','12188'),('92198','12188'),('92283','12193')",
    "('92338','12198'),('92340','12198'),('92610','12237'),('92656','12237'),('92660','12237'),('92677','12237'),('92824','12249'),('93042','12281'),('93043','12281'),('93044','12281'),('93045','12281'),('93046','12281'),('93181','12296'),('93386','12310'),('93387','12310')",
    "('93513','12311'),('93515','12311'),('93516','12310'),('93735','12327'),('93740','12327'),('93878','12327'),('93879','12327'),('93880','12327'),('93881','12327'),('93882','12327'),('93883','12327'),('93884','12327'),('93885','12327'),('93897','12327'),('93990','12329')",
    "('94050','12348'),('94053','12347'),('94060','12348'),('94061','12347'),('94064','12347'),('94065','12347'),('94474','12373'),('94475','12373'),('94476','12373'),('94477','12373'),('94478','12373'),('94498','12373'),('94500','12373'),('94573','12373'),('94688','12379')",
    "('94691','12379'),('94694','12379'),('94698','12379'),('94701','12378'),('94704','12378'),('94705','12378'),('94711','12379'),('94715','12379'),('95052','12390'),('95053','12390'),('95054','12390'),('95055','12385'),('95056','12390'),('95061','12390'),('95081','12390')",
    "('95082','12390'),('95086','12390'),('95149','12393'),('95151','12393'),('95153','12393'),('95220','12395'),('95223','12394'),('95224','12401'),('95225','12401'),('95767','12441'),('95773','12441'),('95848','12447'),('95849','12447'),('95854','12441'),('95873','12447')",
    "('95986','12447'),('96001','12447'),('96002','12447'),('96007','12445'),('96055','12463'),('96122','12467'),('96123','12467'),('96297','12475'),('96441','12483'),('96464','12483'),('96465','12486'),('96658','12494'),('97082','12534'),('97083','12534'),('97084','12534')",
    "('97088','12534'),('97089','12534'),('97111','12534'),('97131','12534'),('97209','12534'),('97210','12538'),('97282','12534'),('97321','12542'),('97322','12542'),('97794','12572'),('97800','12572'),('98884','12627'),('98886','12627'),('98887','12624'),('98929','12629')",
    "('99041','12635'),('99188','12657'),('99195','12657'),('99196','12657'),('99197','12657'),('99198','12657'),('99199','12657'),('99200','12657'),('99201','12657'),('99205','12657'),('99235','12657'),('99236','12657'),('99238','12657'),('99239','12657'),('99240','12657')",
    "('99241','12657'),('99251','12657'),('99252','12657'),('99253','12657'),('99260','12657'),('99262','12657'),('99352','12663'),('99353','12663'),('99500','12667'),('99592','12675'),('99845','12700'),('99846','12700'),('99868','12700'),('99870','12700'),('99879','12715')",
    "('99880','12715'),('99932','12728'),('99933','12728'),('99938','12728'),('99952','12728'),('99953','12728'),('99954','12728'),('99955','12728'),('99956','12728'),('100312','12777'),('100462','12801'),('100866','12820'),('100879','12830'),('100880','12830'),('100881','12830')",
    "('100961','12837'),('101825','12914'),('101929','12920'),('102079','12947'),('102080','12947'),('102177','12960'),('102178','12960'),('102179','12960'),('102180','12951'),('102185','12960'),('102186','12960'),('102188','12960'),('102190','12960'),('102191','12960'),('102192','12960')",
    "('102193','12960'),('102212','12960'),('102219','12960'),('102221','12960'),('102334','12985'),('102612','12985'),('102613','12997'),('102614','12997'),('102615','12997'),('102616','12997'),('102617','12997'),('102618','12997'),('102619','12997'),('102620','12997'),('102621','12997')",
    "('102622','12997'),('102630','12997'),('102631','12997'),('102634','12997'),('102635','12997'),('102637','12997'),('102640','12997'),('102641','12997'),('102642','12997'),('102648','12997'),('102669','13000'),('102672','13000'),('102674','12997'),('102711','12997'),('102712','12997')",
    "('102713','12997'),('102899','13034'),('102903','13035'),('102904','13034'),('102921','13035'),('102922','13035'),('102948','13047'),('102961','13049'),('102962','13049'),('102963','13049'),('103058','13059'),('103059','13059'),('103060','13059'),('103430','13081'),('103431','13081')",
    "('103716','13100'),('103725','13100'),('103726','13107'),('103732','13107'),('103738','13107'),('103746','13113'),('103748','13113'),('103760','13113'),('104212','13155'),('104236','13156'),('104237','13159'),('104424','13184'),('104425','13184'),('104539','13188'),('104681','13200')",
    "('104682','13200'),('104684','13200'),('104813','13222'),('104814','13222'),('104815','13222'),('104823','13222'),('104824','13222'),('104825','13222'),('104865','13239'),('104866','13239'),('104963','13245'),('104964','13245'),('105013','13254'),('105690','13313'),('105971','13339')",
    "('106107','13344'),('106108','13353'),('106113','13339'),('106159','13358'),('106253','13370'),('106375','13370'),('106377','13370'),('106765','13405'),('107030','13428'),('107031','13428'),('107034','13428'),('107062','13428'),('107068','13428'),('107282','13444'),('107470','13444')",
    "('107544','13444'),('107831','13463'),('107958','13482'),('108149','13505'),('108604','13534'),('110010','13614'),('110283','13634'),('110304','13634'),('111069','13692'),('111458','13722'),('111569','13729'),('111632','13736'),('112046','13787'),('112199','13812'),('112211','13812')",
    "('112223','13822'),('112881','13842'),('112940','13847'),('113067','13877'),('113347','13890'),('113348','13890'),('113356','13890'),('113395','13890'),('113432','13890'),('113971','13936'),('113972','13936'),('114128','13948'),('114452','13977'),('114457','13981'),('114464','13978')",
    "('114466','13977'),('114467','13978'),('114469','13978'),('114500','13978'),('114501','13978'),('114502','13978'),('114553','13982'),('114554','13977'),('114856','14009'),('115270','14051'),('115273','14051'),('115274','14051'),('115275','14051'),('115276','14051'),('115569','14067')",
    "('115592','14067'),('115821','14099'),('116011','14127'),('116012','14127'),('116048','14067'),('116049','14127'),('116050','14127'),('116051','14127'),('116052','14127'),('116053','14127'),('116054','14127'),('116055','14127'),('116056','14127'),('116057','14127'),('116058','14127')",
    "('116059','14127'),('116060','14127'),('116061','14127'),('116064','14127'),('116066','14127'),('116067','14127'),('116068','14127'),('116075','14127'),('116080','14127'),('116082','14127'),('116083','14127'),('116084','14127'),('116141','14141'),('116142','14141'),('116152','14141')",
    "('116153','14141'),('116157','14141'),('116774','14203'),('117559','14265'),('117570','14265'),('117582','14265'),('117583','14265'),('117584','14265'),('117631','14265'),('117762','14286'),('117763','14286'),('118278','14330'),('118549','14371'),('118694','14371'),('118824','14382')",
    "('118984','14404'),('118985','14404'),('118996','14404'),('118997','14404'),('118999','14404'),('119000','14404'),('119006','14404'),('119007','14404'),('119014','14404'),('119218','14385'),('119220','14423'),('119225','14423'),('119535','14457'),('119536','14457'),('119537','14457')",
    "('119538','14457'),('119686','14457'),('119845','14481'),('120376','14516'),('120377','14516'),('120420','14495'),('120426','14516'),('120444','14516'),('120550','14532'),('120712','14532'),('120783','14553'),('120875','14555'),('121046','14558'),('121463','14590'),('121645','14617')",
    "('121646','14617'),('121889','14633'),('121897','14635'),('121915','14635'),('121919','14635'),('121926','14640'),('121927','14640'),('121929','14640'),('121930','14640'),('121948','14640'),('121949','14640'),('121970','14640'),('122189','14647'),('122191','14647'),('122642','14665')",
    "('122643','14662'),('122644','14662'),('122645','14661'),('122646','14661'),('123195','14681'),('123267','14681'),('123268','14681'),('123269','14681'),('123294','14684'),('123416','14697'),('123417','14697'),('123418','14697'),('123500','14707'),('123814','14737'),('124212','14779')",
    "('124319','14785'),('124412','14793'),('124507','14803'),('124610','14803'),('124749','14793'),('124836','14827'),('124846','14827'),('124860','14827'),('125156','14868'),('125174','14869'),('125201','14868'),('125205','14868'),('125208','14868'),('125213','14868'),('125214','14868')",
    "('125215','14869'),('125216','14869'),('125378','14907'),('125730','14937'),('125772','14942'),('125773','14942'),('125925','14948'),('125926','14948'),('125927','14948'),('125936','14948'),('125946','14949'),('125982','14949'),('125983','14949'),('125984','14949'),('125985','14949')",
    "('126004','14949'),('126022','14949'),('126079','14966'),('126092','14966'),('126286','14974'),('126353','14980'),('126354','14980'),('126355','14980'),('126386','14984'),('126398','14984'),('126420','14989'),('126421','14989'),('126483','14991'),('126484','14991'),('126513','14991')",
    "('126515','14991'),('126516','14991'),('127069','15025'),('127075','15025'),('127076','15025'),('127077','15025'),('127999','15107'),('128000','15107'),('128065','15114'),('128066','15114'),('128067','15115'),('128068','15115'),('128069','15115'),('128070','15115'),('128075','15110')",
    "('128076','15110'),('128082','15115'),('128086','15115'),('128087','15115'),('128089','15115'),('128092','15115'),('128093','15115'),('128592','15149'),('128869','15174'),('129326','15212'),('129327','15216'),('129328','15215'),('129329','15215'),('129521','15241'),('129742','15257')",
    "('129743','15257'),('129777','15255'),('130942','15337'),('131247','15354'),('131248','15354'),('131250','15354'),('131251','15348'),('131252','15348'),('131324','15354'),('131325','15361'),('131342','15361'),('131358','15345'),('131408','15361'),('131437','15367'),('131454','15368')",
    "('131455','15367'),('131456','15367'),('131458','15367'),('131459','15367'),('131460','15367'),('131461','15367'),('131462','15367'),('131467','15367'),('131472','15367'),('131475','15367'),('131476','15367'),('131478','15367'),('131488','15367'),('131496','15367'),('131507','15367')",
    "('131510','15367'),('131511','15367'),('131654','15377'),('131961','15392'),('132193','15418'),('132205','15418'),('132206','15418'),('132298','15425'),('132676','15449'),('132679','15452'),('132681','15449'),('132759','15452'),('132761','15452'),('132902','15457'),('133118','15468')",
    "('134097','15495'),('134137','15495'),('134225','15505'),('134240','15505'),('134245','15504'),('134249','15505'),('134263','15505'),('134350','15517'),('134351','15517'),('135035','15585'),('135036','15585'),('135037','15585'),('135038','15585'),('135039','15585'),('135040','15585')",
    "('135041','15585'),('135164','15587'),('135183','15585'),('135184','15585'),('135519','15609'),('135529','15609'),('135593','15614'),('135594','15614'),('135922','15630'),('136348','15646'),('136349','15646'),('136350','15646'),('136357','15646'),('136369','15646'),('136845','15674')",
    "('136850','15674'),('137073','15682'),('137529','15700'),('137773','15718'),('137976','15750'),('137977','15750'),('137978','15750'),('137979','15750'),('138011','15750'),('138078','15750'),('138389','15769'),('138721','15793'),('138722','15793'),('138749','15793'),('138766','15793')",
    "('138787','15793'),('138788','15793'),('138789','15793'),('138794','15793'),('138810','15793'),('138811','15793'),('138812','15793'),('138813','15793'),('139007','15814'),('139032','15817'),('139538','15838'),('139594','15838'),('139820','15852'),('139821','15852'),('139828','15852')",
    "('139829','15852'),('139835','15852'),('139867','15852'),('139883','15852'),('139894','15852'),('139949','15864'),('140345','15895'),('140435','15904'),('140540','15908'),('140551','15908'),('140605','15908'),('140900','15922'),('140921','15928'),('141581','15972'),('141834','15987')",
    "('142155','16003'),('142426','16017'),('142427','16017'),('142696','16030'),('142948','16043'),('143074','16052'),('143075','16052'),('143076','16052'),('143084','16052'),('143093','16052'),('143097','16052'),('143098','16052'),('143112','16052'),('143113','16052'),('143114','16052')",
    "('143128','16058'),('143129','16058'),('143130','16058'),('143131','16058'),('143132','16058'),('143133','16058'),('143134','16058'),('143135','16058'),('143176','16058'),('143177','16058'),('143178','16058'),('143179','16058'),('143180','16058'),('143181','16058'),('143182','16058')",
    "('143183','16058'),('143319','16058'),('143320','16058'),('143381','16073'),('143670','16087'),('143708','16100'),('144112','16120'),('145037','16190'),('145343','16196'),('146405','16245'),('146423','16249'),('146424','16249'),('146425','16249'),('146495','16249'),('146754','16259')",
    "('146756','16259'),('146847','16266'),('147380','16311'),('147806','16338'),('147934','16342'),('148135','16362'),('148473','16380'),('148483','16379'),('149039','16387'),('149581','16408'),('150107','16435'),('150237','16443'),('151274','16512'),('151275','16512'),('151276','16512')",
    "('151300','16515'),('151301','16515'),('151302','16515'),('151305','16515'),('152277','16567'),('152298','16569'),('152299','16569'),('152321','16574'),('152325','16569'),('152326','16569'),('152327','16574'),('152328','16569'),('152329','16574'),('152330','16574'),('152331','16574')",
    "('152638','17860'),('152645','17860'),('152649','17860'),('152651','17859'),('152653','17860'),('152661','17859'),('152951','18275'),('152960','18275'),('153121','18291'),('153189','17859'),('153192','18286'),('153194','18291'),('153882','18311'),('153884','18306'),('153912','18311')",
    "('154089','18334'),('154091','18334'),('154222','18344'),('154237','18344'),('154244','18344'),('154366','18346'),('154367','18286'),('154417','18350'),('154520','18359'),('154523','18359'),('154526','18359'),('154608','18370'),('154611','18370'),('154614','18370'),('154621','18370')",
    "('154622','18370'),('154634','18370'),('155218','18389'),('155310','18391'),('155745','18410'),('155746','18410'),('155786','18415'),('155788','18415'),('155793','18415'),('155794','18415'),('155795','18410'),('156114','18449'),('156115','18449'),('156140','18449'),('156352','18458')",
    "('156396','18466'),('156397','18467'),('156401','18466'),('156402','18467'),('156410','18466'),('156438','18477'),('156439','18477'),('156440','18477'),('156441','18477'),('156442','18477'),('156776','18502'),('156808','18513'),('156937','18528'),('157004','18532'),('157183','18545')",
    "('157296','18551'),('157405','18561'),('157408','18563'),('157430','18566'),('157586','18588'),('157587','18588'),('157588','18588'),('157594','18588'),('157595','18588'),('157596','18588'),('157600','18588'),('157603','18588'),('158018','18615'),('158019','18615'),('158031','18615')",
    "('158038','18615'),('158046','18615'),('158047','18617'),('158482','18643'),('158483','18643'),('158510','18643'),('159064','18666'),('159154','18672'),('159300','18672'),('159332','18694'),('159334','18694'),('159541','18709'),('159542','18709'),('159565','18709'),('159570','18709')",
    "('159857','18740'),('159858','18740'),('159860','18740'),('160173','18745'),('160250','18745'),('160294','18754'),('160295','18754'),('160328','18754'),('160340','18766'),('160371','18766'),('160372','18766'),('160373','18766'),('160384','18766'),('160639','18783'),('160641','18783')",
    "('160642','18781'),('160645','18783'),('160665','18783'),('160668','18783'),('160671','18783'),('160697','18783'),('160698','18783'),('160702','18783'),('161531','18851'),('161535','18851'),('161558','18855'),('161559','18855'),('162170','18886'),('162212','18896'),('162220','18895')",
    "('162769','18927'),('162770','18927'),('163830','18956'),('164217','18981'),('164240','18981'),('164241','18981'),('164252','18981'),('164253','18981'),('164254','18981'),('164259','18981'),('164281','18981'),('164291','18981'),('164412','18981'),('164461','18990'),('164810','19022')",
    "('164811','19022'),('164826','19023'),('164827','19022'),('164828','19022'),('164841','19023'),('164843','19022'),('164849','19023'),('164850','19023'),('164854','19022'),('164855','19022'),('164973','19023'),('165107','19029'),('165115','19029'),('165116','19029'),('165122','19029')",
    "('165146','19029'),('165232','19041'),('165786','19072'),('165787','19072'),('165795','19072'),('165933','19099'),('166212','19121'),('166213','19121'),('166214','19121'),('166215','19121'),('166216','19121'),('166217','19121'),('166218','19121'),('166219','19121'),('166220','19121')",
    "('166221','19121'),('166222','19121'),('166223','19121'),('166224','19121'),('166225','19121'),('166580','19164'),('166688','19170'),('167076','19195'),('167342','19205'),('167343','19205'),('167348','19205'),('167349','19205'),('167350','19205'),('167679','19227'),('167699','19235')",
    "('167701','19235'),('167704','19235'),('167706','19235'),('167707','19235'),('167731','19235'),('167784','19254'),('167789','19254'),('167864','19263'),('167956','19264'),('168157','19264'),('168349','19288'),('168375','19288'),('168376','19288'),('168435','19295'),('168511','19307')",
    "('168911','19340'),('168972','19340'),('169078','19347'),('169160','19358'),('169163','19358'),('169812','19380'),('169813','19381'),('169814','19381'),('170064','19402'),('170066','19402'),('170067','19402'),('170133','19402'),('170171','19405'),('170174','19404'),('170208','19406')",
    "('170229','19407'),('170408','19423'),('170409','19423'),('170410','19423'),('170411','19423'),('170416','19426'),('170421','19426'),('170537','19448'),('170538','19423'),('170651','19454'),('170691','19461'),('170798','19472'),('170799','19472'),('170800','19472'),('170801','19472')",
    "('170807','19472'),('170808','19472'),('170810','19472'),('171121','19490'),('171122','19490'),('171123','19490'),('171126','19490'),('171164','19490'),('171952','19530'),('171992','19533'),('172433','19533'),('172992','19583'),('173022','19583'),('173032','19583'),('173284','19596')",
    "('173285','19596'),('173466','19602'),('173495','19602'),('173500','19602'),('173527','19602'),('173576','19602'),('173592','19602'),('173651','19616'),('173764','19621'),('173836','19629'),('173919','19636'),('174047','19650'),('174048','19650'),('174722','19679'),('174732','19679')",
    "('174734','19679'),('174735','19679'),('174740','19679'),('174765','19679'),('174766','19679'),('174767','19679'),('175067','19696'),('175295','19721'),('175434','19721'),('175599','19752'),('175626','19752'),('176050','19764'),('176151','19771'),('176152','19771'),('176171','19771')",
    "('176172','19771'),('176173','19771'),('176185','19771'),('176188','19771'),('176291','19782'),('176322','19782'),('176571','19795'),('176596','19795'),('176603','19795'),('176610','19798'),('176931','19808'),('177225','19832'),('177229','19832'),('177295','19841'),('177829','19875')",
    "('177915','19889'),('177952','19900'),('178075','19910'),('178076','19910'),('178096','19910'),('178097','19910'),('178314','19934'),('178325','19935'),('178375','19949'),('178903','19988'),('178904','19988'),('178992','19988'),('179145','19996'),('179330','20003'),('179358','20003')",
    "('179415','20007'),('179693','20022'),('180115','20048'),('181086','20083'),('181171','20088'),('181860','20117'),('181870','20117'),('182435','20126'),('182820','20164'),('182821','20164'),('182822','20164'),('182823','20164'),('182827','20164'),('182832','20164'),('182838','20164')",
    "('182926','20171'),('183225','20191'),('183878','20225'),('183885','20227'),('184060','20238'),('184504','20268'),('184505','20268'),('184506','20268'),('184517','20268'),('184780','20286'),('184781','20286'),('184798','20286'),('184799','20286'),('184800','20286'),('184801','20286')",
    "('184802','20286'),('184803','20286'),('184804','20286'),('184854','20290'),('184859','20290'),('184862','20290'),('184864','20290'),('184873','20290'),('184874','20290'),('184914','20290'),('184915','20290'),('185000','20290'),('185006','20290'),('185184','20294'),('185618','20314')",
    "('185619','20314'),('185667','20317'),('185813','20332'),('185818','20332'),('185819','20332'),('185832','20332'),('185834','20332'),('185891','20332'),('186276','20351'),('186350','20355'),('186351','20355'),('186485','20365'),('186526','20365'),('186627','20368'),('186641','20368')",
    "('186779','20380'),('186781','20380'),('186806','20380'),('187770','20403'),('187771','20403'),('187772','20403'),('187773','20403'),('187786','20404'),('188105','20420'),('188132','20432'),('188140','20436'),('188145','20436'),('188146','20436'),('188619','20465'),('188622','20465')",
    "('188648','20465'),('188664','20470'),('188903','20481'),('188919','20481'),('188920','20481'),('188933','20481'),('188934','20486'),('188944','20486'),('188947','20481'),('189121','20497'),('189132','20497'),('189154','20504'),('189474','20524'),('189818','20560'),('189900','20569')",
    "('190042','20573'),('190576','20614'),('190577','20614'),('191331','20642'),('191797','20662'),('191835','20662'),('191881','20662'),('192026','20675'),('192027','20675'),('192028','20675'),('192029','20675'),('192109','20679'),('192364','20691'),('192365','20691'),('192422','20695')",
    "('192431','20695'),('192432','20695'),('192433','20695'),('192434','20695'),('192436','20695'),('192438','20695'),('192809','20691'),('192810','20691'),('192813','20713'),('192822','20711'),('192884','20713'),('192885','20713'),('192887','20713'),('193554','20749'),('193705','20759')",
    "('194430','20806'),('194434','20806'),('194435','20806'),('194682','20815'),('195329','20839'),('195330','20839'),('195331','20839'),('195332','20839'),('195333','20839'),('195334','20839'),('195393','20845'),('195394','20845'),('195395','20845'),('195514','20852'),('195518','20852')",
    "('195675','20864'),('195682','20864'),('195683','20864'),('195735','20864'),('195736','20864'),('195737','20864'),('195738','20864'),('195960','20874'),('196128','20879'),('196217','20881'),('196218','20881'),('196219','20881'),('196783','20926'),('196784','20925'),('196785','20925')",
    "('196797','20925'),('196798','20925'),('196800','20925'),('196979','20941'),('197005','20941'),('198903','21019'),('199220','21029'),('199222','21029'),('199226','21029'),('199508','21041'),('199609','21048'),('199926','21074'),('200412','21112'),('200413','21112'),('200421','21112')",
    "('200422','21118'),('200447','21116'),('200450','21118'),('200480','21116'),('200483','21116'),('200489','21116'),('200526','21116'),('201413','21173'),('201415','21173'),('201416','21173'),('201474','21173'),('201479','21173'),('201480','21173'),('201514','21173'),('201956','21197')",
    "('202812','21226'),('202878','21226'),('202879','21226'),('202880','21226'),('202881','21226'),('202882','21226'),('202883','21226'),('202884','21226'),('202885','21226'),('202889','21226'),('203485','21255'),('203503','21255'),('203504','21255'),('203505','21255'),('203550','21255')",
    "('203551','21255'),('203552','21255'),('203553','21255'),('203554','21255'),('203568','21255'),('203854','21266'),('203855','21266'),('203873','21266'),('204106','21275'),('204107','21275'),('204492','21285'),('204493','21285'),('204494','21285'),('204534','21285'),('204585','21285')",
    "('204920','21311'),('204921','21311'),('205044','21317'),('205060','21317'),('205113','21325'),('205245','21330'),('205247','21330'),('205248','21330'),('205249','21330'),('205292','21336'),('205889','21368'),('206676','21397'),('206698','21402'),('206712','21402'),('206765','21405')",
    "('206813','21408'),('207311','21445'),('207337','21445'),('208016','21478'),('208314','21503'),('208315','21503'),('208317','21503'),('208780','21522'),('208781','21522'),('208788','21522'),('208789','21522'),('208790','21522'),('208791','21522'),('208804','21522'),('208820','21522')",
    "('208821','21522'),('208822','21522'),('208824','21522'),('208827','21522'),('208828','21522'),('208838','21522'),('208851','21522'),('208852','21522'),('208853','21522'),('208859','21522'),('208873','21522'),('208874','21522'),('208876','21522'),('208877','21522'),('208920','21532')",
    "('210293','21571'),('210310','21571'),('210326','21571'),('210335','21571'),('210384','21574'),('210391','21578'),('210452','21578'),('210453','21578'),('210454','21578'),('210455','21578'),('210457','21578'),('210458','21578'),('210460','21578'),('210461','21578'),('210462','21578')",
    "('210463','21578'),('210464','21578'),('210465','21578'),('210466','21578'),('210467','21578'),('210469','21578'),('210470','21578'),('210471','21578'),('210474','21578'),('210478','21578'),('210545','21574'),('210547','21578'),('210549','21578'),('210818','21579'),('210821','21589')",
    "('210834','21589'),('211032','21603'),('211648','21619'),('211649','21619'),('211664','21619'),('211665','21619'),('211666','21619'),('211667','21619'),('211668','21619'),('211992','21628'),('212777','21659'),('212779','21659'),('212781','21659'),('212784','21659'),('212786','21659')",
    "('212788','21659'),('212790','21659'),('212792','21659'),('212940','21659'),('213028','21659'),('213030','21659'),('213264','21680'),('213265','21680'),('213266','21675'),('213273','21679'),('213643','21698'),('213644','21698'),('213733','21698'),('214302','21743'),('214303','21743')",
    "('214464','21750'),('214772','21773'),('215081','21787'),('215082','21788'),('215365','21808'),('215385','21808'),('215386','21808'),('215387','21808'),('215404','21808'),('215405','21808'),('215406','21808'),('215407','21808'),('215408','21808'),('215409','21808'),('215430','21808')",
    "('215431','21808'),('215461','21808'),('215481','21808'),('215488','21808'),('215489','21808'),('215491','21808'),('215511','21808'),('215522','21808'),('215529','21808'),('215531','21808'),('215532','21808'),('215534','21808'),('215561','21808'),('215566','21808'),('215568','21808')",
    "('215912','21832'),('216400','21853'),('217295','21885'),('217296','21885'),('217298','21885'),('217332','21885'),('217334','21885'),('217361','21885'),('217387','21885'),('217389','21885'),('217453','21889'),('217962','21920'),('217963','21920'),('217965','21920'),('218090','21929')",
    "('218091','21929'),('218642','21948'),('218647','21948'),('218676','21948'),('218707','21952'),('218763','21957'),('218778','21957'),('218780','21957'),('218789','21957'),('218806','21957'),('219003','21967'),('219106','21978'),('219128','21973'),('219129','21973'),('219230','21987')",
    "('219806','22020'),('219807','22020'),('219808','22020'),('219809','22020'),('219811','22020'),('220104','22036'),('220106','22036'),('220777','22044'),('220846','22044'),('221029','22054'),('221030','22054'),('221035','22056'),('221036','22056'),('221044','22056'),('221117','22063')",
    "('221118','22063'),('221119','22063'),('221120','22063'),('221121','22063'),('221122','22063'),('221123','22063'),('221125','22063'),('221126','22063'),('221127','22062'),('221128','22062'),('221129','22062'),('221130','22062'),('221131','22062'),('221132','22062'),('221133','22062')",
    "('221134','22062'),('221135','22063'),('221136','22063'),('221183','22063'),('221193','22062'),('221196','22072'),('221202','22072'),('221232','22063'),('221264','22072'),('221270','22063'),('221411','22076'),('221412','22076'),('221804','22095'),('221805','22095'),('221806','22095')",
    "('221816','22095'),('221931','22098'),('221932','22098'),('221934','22098'),('221937','22098'),('221938','22098'),('221939','22098'),('221944','22098'),('222250','22115'),('222284','22115'),('222328','22121'),('222329','22121'),('222330','22121'),('222339','22121'),('222341','22121')",
    "('222343','22121'),('222347','22121'),('222349','22121'),('222351','22121'),('222361','22121'),('222474','22130'),('222481','22130'),('222484','22130'),('222537','22130'),('222571','22130'),('222572','22130'),('222623','22133'),('222788','22141'),('222896','22149'),('222921','22149')",
    "('222922','22149'),('222923','22149'),('222936','22149'),('222969','22152'),('222970','22152'),('222971','22152'),('222972','22152'),('222973','22152'),('222974','22152'),('222975','22152'),('222976','22152'),('223005','22152'),('223022','22152'),('223031','22152'),('224007','22200')",
    "('224210','22212'),('224296','22217'),('224733','22233'),('224734','22233'),('224735','22233'),('224736','22233'),('224737','22233'),('224738','22233'),('224739','22233'),('224740','22233'),('224741','22233'),('224742','22233'),('224743','22233'),('224744','22233'),('224764','22233')",
    "('224765','22233'),('224766','22233'),('224767','22233')"
);

// Funzione per processare query con batch
function processaBatch($wpdb, $batch_array, $tipo_query = 'preview') {
    $risultati_totali = array();
    $count_totale = 0;
    
    foreach ($batch_array as $batch) {
        $batch_str = rtrim($batch, ',');
        
        if ($tipo_query === 'preview') {
            $sql = "
            SELECT m.ID, m.post_title, m.post_author, pm_m.meta_value as id_old_manifesto,
                   n.ID as necrologio_id, pm_n.meta_value as id_old_necrologio
            FROM wp_posts m
            INNER JOIN wp_postmeta pm_m ON m.ID = pm_m.post_id AND pm_m.meta_key = 'id_old'
            INNER JOIN wp_posts n ON n.post_type = 'annuncio-di-morte'
            INNER JOIN wp_postmeta pm_n ON n.ID = pm_n.post_id AND pm_n.meta_key = 'id_old'
            WHERE m.post_type = 'manifesto'
            AND (pm_m.meta_value, pm_n.meta_value) IN ($batch_str)
            ";
            
            $batch_results = $wpdb->get_results($sql);
            $risultati_totali = array_merge($risultati_totali, $batch_results);
            
        } elseif ($tipo_query === 'count') {
            $sql = "
            SELECT COUNT(DISTINCT m.ID) as totale
            FROM wp_posts m
            INNER JOIN wp_postmeta pm_m ON m.ID = pm_m.post_id AND pm_m.meta_key = 'id_old'
            INNER JOIN wp_posts n ON n.post_type = 'annuncio-di-morte'
            INNER JOIN wp_postmeta pm_n ON n.ID = pm_n.post_id AND pm_n.meta_key = 'id_old'
            WHERE m.post_type = 'manifesto'
            AND (pm_m.meta_value, pm_n.meta_value) IN ($batch_str)
            ";
            
            $count_totale += $wpdb->get_var($sql);
        }
    }
    
    return ($tipo_query === 'count') ? $count_totale : $risultati_totali;
}

if ($action === 'preview') {
    // DEBUG: Prima mostra alcune info di debug
    echo "<h3>DEBUG INFO</h3>";
    echo "Numero di batch: " . count($coppie_batch1) . "<br>";
    
    // Test semplice per vedere se ci sono manifesti
    $test_manifesti = $wpdb->get_var("SELECT COUNT(*) FROM wp_posts WHERE post_type = 'manifesto'");
    $test_necrologi = $wpdb->get_var("SELECT COUNT(*) FROM wp_posts WHERE post_type = 'annuncio-di-morte'");
    echo "Manifesti totali: $test_manifesti<br>";
    echo "Necrologi totali: $test_necrologi<br>";
    
    // Test prima coppia
    $test_prima_coppia = $wpdb->get_results("
        SELECT m.ID, pm_m.meta_value as id_manifesto, n.ID, pm_n.meta_value as id_necrologio
        FROM wp_posts m
        INNER JOIN wp_postmeta pm_m ON m.ID = pm_m.post_id AND pm_m.meta_key = 'id_old'
        INNER JOIN wp_posts n ON n.post_type = 'annuncio-di-morte'  
        INNER JOIN wp_postmeta pm_n ON n.ID = pm_n.post_id AND pm_n.meta_key = 'id_old'
        WHERE m.post_type = 'manifesto'
        AND pm_m.meta_value = '23851' AND pm_n.meta_value = '3237'
    ");
    echo "Test prima coppia (23851, 3237): " . count($test_prima_coppia) . " risultati<br><br>";
    
    // STEP 1: PREVIEW - Usa la funzione batch
    $results = processaBatch($wpdb, $coppie_batch1, 'preview');
    
    // Limita i risultati per il preview
    $results = array_slice($results, 0, 100);
    
    // Se la query fallisce, mostra l'errore
    if ($wpdb->last_error) {
        echo "<strong>ERRORE SQL:</strong> " . $wpdb->last_error . "<br><br>";
    }
    
    // Conta totale
    $totale = processaBatch($wpdb, $coppie_batch1, 'count');
    
    echo "<h3>PREVIEW - Manifesti che saranno modificati:</h3>";
    echo "<p>Mostrando primi 100 di $totale manifesti totali</p>";
    echo "<table border='1' style='border-collapse: collapse; width: 100%;'>";
    echo "<tr><th>ID Manifesto</th><th>Titolo</th><th>Autore Attuale</th><th>ID Old Manifesto</th><th>ID Old Necrologio</th></tr>";
    
    foreach ($results as $row) {
        echo "<tr>";
        echo "<td>$row->ID</td>";
        echo "<td>" . substr($row->post_title, 0, 50) . "...</td>";
        echo "<td>$row->post_author</td>";
        echo "<td>$row->id_old_manifesto</td>";
        echo "<td>$row->id_old_necrologio</td>";
        echo "</tr>";
    }
    echo "</table>";
    
    echo "<br><strong>Totale manifesti da modificare: $totale</strong>";
    echo "<br><strong>Nuovo autore: 157</strong>";
    
    echo "<br><br><a href='?pass=temp123&action=backup' style='background: orange; color: white; padding: 10px; text-decoration: none;'>1. CREA BACKUP</a>";
    echo " → <a href='?pass=temp123&action=execute' style='background: red; color: white; padding: 10px; text-decoration: none;'>2. ESEGUI MODIFICA</a>";
    echo " → <a href='?pass=temp123&action=restore' style='background: blue; color: white; padding: 10px; text-decoration: none;'>3. RIPRISTINA (se necessario)</a>";
    
} elseif ($action === 'backup') {
    // STEP 2: BACKUP - Salva i dati originali con batch
    $wpdb->query("DROP TABLE IF EXISTS wp_temp_manifesti_backup");
    $wpdb->query("CREATE TABLE wp_temp_manifesti_backup (ID bigint, post_author bigint, id_old varchar(255), backup_time datetime)");
    
    foreach ($coppie_batch1 as $batch) {
        $batch_str = rtrim($batch, ',');
        
        $backup_sql = "
        INSERT INTO wp_temp_manifesti_backup (ID, post_author, id_old, backup_time)
        SELECT DISTINCT m.ID, m.post_author, pm_m.meta_value as id_old, NOW() as backup_time
        FROM wp_posts m
        INNER JOIN wp_postmeta pm_m ON m.ID = pm_m.post_id AND pm_m.meta_key = 'id_old'
        INNER JOIN wp_posts n ON n.post_type = 'annuncio-di-morte'
        INNER JOIN wp_postmeta pm_n ON n.ID = pm_n.post_id AND pm_n.meta_key = 'id_old'
        WHERE m.post_type = 'manifesto'
        AND (pm_m.meta_value, pm_n.meta_value) IN ($batch_str)
        ";
        
        $wpdb->query($backup_sql);
        
        if ($wpdb->last_error) {
            echo "❌ ERRORE nel backup batch: " . $wpdb->last_error . "<br>";
            break;
        }
    }
    
    $count = $wpdb->get_var("SELECT COUNT(*) FROM wp_temp_manifesti_backup");
    if ($count > 0) {
        echo "<h3>✅ BACKUP CREATO</h3>";
        echo "Salvati $count record nella tabella wp_temp_manifesti_backup<br><br>";
        echo "<a href='?pass=temp123&action=execute' style='background: red; color: white; padding: 10px; text-decoration: none;'>PROCEDI CON LA MODIFICA</a>";
    } else {
        echo "❌ ERRORE: Nessun record salvato nel backup";
    }
    
} elseif ($action === 'execute') {
    // STEP 3: EXECUTE - Esegui la modifica con batch
    $total_updated = 0;
    
    foreach ($coppie_batch1 as $batch) {
        $batch_str = rtrim($batch, ',');
        
        $update_sql = "
        UPDATE wp_posts m
        INNER JOIN wp_postmeta pm_m ON m.ID = pm_m.post_id AND pm_m.meta_key = 'id_old'
        INNER JOIN wp_posts n ON n.post_type = 'annuncio-di-morte'
        INNER JOIN wp_postmeta pm_n ON n.ID = pm_n.post_id AND pm_n.meta_key = 'id_old'
        SET m.post_author = 157
        WHERE m.post_type = 'manifesto'
        AND (pm_m.meta_value, pm_n.meta_value) IN ($batch_str)
        ";
        
        $result = $wpdb->query($update_sql);
        
        if ($result === false) {
            echo "❌ ERRORE nell'update batch: " . $wpdb->last_error . "<br>";
            break;
        }
        
        $total_updated += $result;
    }
    
    if ($total_updated > 0) {
        echo "<h3>✅ MODIFICA COMPLETATA</h3>";
        echo "Modificati $total_updated manifesti - Nuovo autore: 157<br><br>";
        echo "Se qualcosa è andato storto:<br>";
        echo "<a href='?pass=temp123&action=restore' style='background: blue; color: white; padding: 10px; text-decoration: none;'>RIPRISTINA BACKUP</a>";
    } else {
        echo "❌ ERRORE: Nessun manifesto è stato modificato";
    }
    
} elseif ($action === 'restore') {
    // STEP 4: RESTORE - Ripristina dal backup
    if ($wpdb->get_var("SHOW TABLES LIKE 'wp_temp_manifesti_backup'")) {
        $restore_sql = "
        UPDATE wp_posts p
        INNER JOIN wp_temp_manifesti_backup b ON p.ID = b.ID
        SET p.post_author = b.post_author
        ";
        
        $result = $wpdb->query($restore_sql);
        
        if ($result !== false) {
            echo "<h3>✅ RIPRISTINO COMPLETATO</h3>";
            echo "Ripristinati $result manifesti ai valori originali<br><br>";
            echo "Backup eliminato automaticamente.";
            $wpdb->query("DROP TABLE wp_temp_manifesti_backup");
        } else {
            echo "❌ ERRORE nel ripristino: " . $wpdb->last_error;
        }
    } else {
        echo "❌ Backup non trovato!";
    }
}

echo "<br><br><a href='?pass=temp123'>← Torna al Preview</a>";
echo "<br><br><strong>RICORDA: Elimina questo file dopo l'uso!</strong>";
?>